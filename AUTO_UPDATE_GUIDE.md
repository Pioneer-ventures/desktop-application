# Auto-Update Guide for HRMS Desktop

This guide explains how to set up and use the auto-update feature for the HRMS Desktop application.

## How It Works

1. **App checks for updates** automatically:
   - On startup (after 5 seconds)
   - Every 4 hours while running

2. **When update is found**:
   - User is notified with a dialog
   - User can choose to download now or later

3. **After download**:
   - User is prompted to restart and install
   - App restarts automatically after installation

## Setup Your Update Server

### Step 1: Choose a Server

You have several options:

#### Option A: Simple HTTP Server (Easiest)

1. Use any web hosting service (even free ones like Netlify, Vercel, GitHub Pages)
2. Create a folder structure:
   ```
   updates/
   ├── latest.yml
   ├── HRMS Desktop-1.0.0-x64.exe
   ├── HRMS Desktop-1.0.1-x64.exe
   └── ...
   ```

#### Option B: Use Your Existing Server

If you already have a server (like the one running on Fly.io), add an update endpoint:

```javascript
// Add to your Express server
app.use('/updates', express.static(path.join(__dirname, 'updates')));
```

#### Option C: Cloud Storage (Recommended for Production)

- **AWS S3**: Create a bucket, enable static hosting
- **Google Cloud Storage**: Similar setup
- **Azure Blob Storage**: Similar setup

### Step 2: Configure Update URL

Edit `desktop-app/package.json`:

```json
"publish": {
  "provider": "generic",
  "url": "https://your-server.com/updates/"
}
```

Replace `https://your-server.com/updates/` with your actual server URL.

### Step 3: Build and Upload Updates

When you want to release a new version:

1. **Update version** in `package.json`:
   ```json
   "version": "1.0.1"
   ```

2. **Build the app**:
   ```bash
   npm run build:win
   ```

3. **Upload files to your server**:
   - Upload `release/HRMS Desktop-1.0.1-x64.exe` to your `updates/` folder
   - Upload `release/latest.yml` to your `updates/` folder
   - The `latest.yml` file is automatically generated and contains update metadata

4. **That's it!** All installed apps will detect the update on their next check.

## Update Server Structure

Your server should have this structure:

```
https://your-server.com/updates/
├── latest.yml          (auto-generated by electron-builder)
├── HRMS Desktop-1.0.0-x64.exe
├── HRMS Desktop-1.0.1-x64.exe
├── HRMS Desktop-1.0.2-x64.exe
└── ...
```

## Example: Simple Update Server (Node.js)

Create a simple server to host updates:

```javascript
// update-server/server.js
const express = require('express');
const path = require('path');
const app = express();

// Serve update files
app.use('/updates', express.static(path.join(__dirname, 'updates')));

// CORS headers (if needed)
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
  next();
});

const PORT = process.env.PORT || 3002;
app.listen(PORT, () => {
  console.log(`Update server running on port ${PORT}`);
  console.log(`Update files should be in: ${path.join(__dirname, 'updates')}`);
});
```

Deploy this server and upload your update files to the `updates/` folder.

## Workflow for Releasing Updates

1. **Make code changes**

2. **Update version** in `package.json`:
   ```json
   "version": "1.0.2"
   ```

3. **Build**:
   ```bash
   npm run build:win
   ```

4. **Upload to server**:
   - Copy `release/HRMS Desktop-1.0.2-x64.exe` → `your-server/updates/`
   - Copy `release/latest.yml` → `your-server/updates/`

5. **Done!** Apps will auto-update.

## Testing Updates

1. Install version 1.0.0 on a test machine
2. Build version 1.0.1
3. Upload 1.0.1 files to your update server
4. Launch the 1.0.0 app
5. Wait 5 seconds - update dialog should appear
6. Test the update flow

## Environment Variables

You can override the update server URL:

```bash
# Windows
set UPDATE_SERVER_URL=https://your-server.com/updates/
npm run build:win

# macOS/Linux
UPDATE_SERVER_URL=https://your-server.com/updates/
npm run build:mac
```

## Important Notes

- ✅ **NSIS installer required**: Auto-updates only work with NSIS installers (not portable EXEs)
- ✅ **HTTPS recommended**: Use HTTPS for your update server in production
- ✅ **Version numbers**: Always increment version numbers (1.0.0 → 1.0.1 → 1.0.2)
- ✅ **latest.yml**: This file is automatically generated - always upload it with the EXE
- ⚠️ **Code signing**: For production, code signing is recommended (but not required)

## Troubleshooting

### Updates not detected?

1. Check update server URL is correct
2. Verify `latest.yml` is accessible: `https://your-server.com/updates/latest.yml`
3. Check version number is higher than current version
4. Ensure NSIS installer is used (not portable)

### Update fails to download?

1. Check EXE file is accessible
2. Verify file permissions on server
3. Check CORS headers if using a different domain
4. Ensure sufficient disk space on user's machine

## Security

- Use HTTPS for update server
- Verify file integrity (electron-updater does this automatically)
- Consider code signing for production deployments
- Validate update server responses

---

**Next Steps**: Set up your update server and configure the URL in `package.json`, then build and test!

