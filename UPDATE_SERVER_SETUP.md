# Auto-Update Server Setup Guide

This guide explains how to set up an auto-update server for the HRMS Desktop application.

## Overview

The app uses `electron-updater` with a generic server provider. When you build a new version, you upload the update files to your server, and all installed apps will automatically check for and download updates.

## Update Server Requirements

You need a web server that can serve static files. Options include:

1. **Simple HTTP Server** (Node.js, Python, etc.)
2. **Cloud Storage** (AWS S3, Google Cloud Storage, Azure Blob Storage)
3. **CDN** (Cloudflare, etc.)
4. **GitHub Releases** (free option)
5. **Your own server** (Express.js, Nginx, etc.)

## Server Structure

Your update server should have this structure:

```
updates/
├── latest.yml (or latest-mac.yml for macOS)
├── HRMS Desktop-1.0.0-x64.exe
├── HRMS Desktop-1.0.1-x64.exe
├── HRMS Desktop-1.0.2-x64.exe
└── ... (all versions)
```

## Configuration

### 1. Update package.json

Set your update server URL in `package.json`:

```json
"publish": {
  "provider": "generic",
  "url": "https://your-update-server.com/updates/"
}
```

Or set via environment variable when building:

```bash
UPDATE_SERVER_URL=https://your-update-server.com/updates/ npm run build:win
```

### 2. Build and Publish Updates

When you want to release an update:

1. **Increment version** in `package.json`:
   ```json
   "version": "1.0.1"
   ```

2. **Build the app**:
   ```bash
   npm run build:win
   ```

3. **Upload files to server**:
   - Upload the EXE file from `release/` folder
   - Upload the `latest.yml` file (auto-generated by electron-builder)

## Option 1: Simple Node.js Update Server

Create a simple Express server:

```javascript
// update-server.js
const express = require('express');
const path = require('path');
const app = express();

app.use('/updates', express.static(path.join(__dirname, 'updates')));

app.listen(3000, () => {
  console.log('Update server running on http://localhost:3000');
});
```

Place your update files in an `updates/` folder and run the server.

## Option 2: GitHub Releases (Free)

1. Create a GitHub repository
2. Configure in `package.json`:
   ```json
   "publish": {
     "provider": "github",
     "owner": "your-username",
     "repo": "hrms-desktop"
   }
   ```
3. Set `GH_TOKEN` environment variable with GitHub personal access token
4. Build with: `npm run build:win -- --publish always`

## Option 3: AWS S3

1. Create an S3 bucket
2. Enable static website hosting
3. Upload files to bucket
4. Set URL in `package.json`:
   ```json
   "publish": {
     "provider": "s3",
     "bucket": "your-bucket-name",
     "region": "us-east-1"
   }
   ```

## Option 4: Custom Server (Recommended for Production)

### Server Setup (Express.js Example)

```javascript
// server/update-server.js
const express = require('express');
const path = require('path');
const fs = require('fs');

const app = express();
const UPDATES_DIR = path.join(__dirname, 'updates');

// Serve update files
app.use('/updates', express.static(UPDATES_DIR));

// API endpoint to check for updates
app.get('/api/check-update', (req, res) => {
  const currentVersion = req.query.version || '0.0.0';
  const latestYml = path.join(UPDATES_DIR, 'latest.yml');
  
  if (fs.existsSync(latestYml)) {
    const ymlContent = fs.readFileSync(latestYml, 'utf-8');
    // Parse version from latest.yml
    const versionMatch = ymlContent.match(/version:\s*([\d.]+)/);
    const latestVersion = versionMatch ? versionMatch[1] : null;
    
    if (latestVersion && latestVersion !== currentVersion) {
      res.json({
        updateAvailable: true,
        version: latestVersion,
        url: `${req.protocol}://${req.get('host')}/updates/latest.yml`
      });
    } else {
      res.json({ updateAvailable: false });
    }
  } else {
    res.json({ updateAvailable: false });
  }
});

app.listen(3002, () => {
  console.log('Update server running on port 3002');
});
```

### Deploy to Your Server

1. Upload the server code to your server
2. Install dependencies: `npm install express`
3. Create `updates/` directory
4. Run the server: `node update-server.js`
5. Update `package.json` with your server URL

## Workflow for Releasing Updates

1. **Make your changes** to the codebase

2. **Update version** in `package.json`:
   ```json
   "version": "1.0.1"
   ```

3. **Build the app**:
   ```bash
   npm run build:win
   ```

4. **Upload to server**:
   - Copy `release/HRMS Desktop-1.0.1-x64.exe` to your server's `updates/` folder
   - Copy `release/latest.yml` to your server's `updates/` folder
   - The `latest.yml` file tells electron-updater about the latest version

5. **Apps will auto-update**:
   - Apps check for updates on startup
   - Apps check every 4 hours
   - When update is found, users are prompted to download
   - After download, users are prompted to restart and install

## Testing Updates

1. Install version 1.0.0 on a test machine
2. Build version 1.0.1
3. Upload 1.0.1 files to your update server
4. Launch the 1.0.0 app - it should detect the update
5. Test the update flow

## Security Considerations

- Use HTTPS for your update server
- Verify update signatures (requires code signing)
- Validate update files before installation
- Use authentication if needed

## Environment Variables

You can override the update server URL:

```bash
# Windows
set UPDATE_SERVER_URL=https://your-server.com/updates/
npm run build:win

# macOS/Linux
UPDATE_SERVER_URL=https://your-server.com/updates/
npm run build:mac
```

## Notes

- The `latest.yml` file is automatically generated by electron-builder
- Only NSIS installers support auto-updates (not portable EXEs)
- Updates work best with code-signed applications
- Users must have internet connection to check for updates

